<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kubb Tracker</title>

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json" />

<!-- Barva adresního řádku v mobilu -->
<meta name="theme-color" content="#003366" />

<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 1rem; background: #f0f8ff; }
  h1 { color: #003366; }
  input, button { padding: 0.4rem; margin: 0.2rem 0; font-size: 1rem; }
  #user-list div { margin-bottom: 0.3rem; cursor: pointer; background: #e6f0ff; padding: 0.4rem; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
  #user-list button { background: #cc0000; color: white; border: none; border-radius: 3px; padding: 0.2rem 0.6rem; cursor: pointer; }
  #history-list div { background: #dde9f7; margin: 0.3rem 0; padding: 0.4rem; border-radius: 5px; }
  .hit-btn { background: #0074d9; color: white; border: none; margin: 0 0.1rem; padding: 0.5rem 0.8rem; border-radius: 4px; cursor: pointer; }
  .hit-btn.selected { background: #0053a6; }
  label { margin-right: 0.5rem; }
  #current-training-summary { background: #d0e1ff; padding: 0.6rem; margin-top: 1rem; border-radius: 6px; }
</style>
</head>
<body>

<h1>Kubb Tracker</h1>

<section>
  <h2>Uživatelé</h2>
  <input type="text" id="user-name-input" placeholder="Jméno uživatele" />
  <button id="add-user-btn">Přidat uživatele</button>
  <div id="user-list"></div>
</section>

<section style="margin-top: 2rem;">
  <h2>Trénink - <span id="current-user-name">žádný</span></h2>

  <div>
    <label>Vyber shozených kubbů (kliknutím se uloží série):</label><br />
    <div id="hit-buttons">
      <button class="hit-btn" data-value="0">0</button>
      <button class="hit-btn" data-value="1">1</button>
      <button class="hit-btn" data-value="2">2</button>
      <button class="hit-btn" data-value="3">3</button>
      <button class="hit-btn" data-value="4">4</button>
      <button class="hit-btn" data-value="5">5</button>
    </div>
  </div>

  <div style="margin-top: 1rem;">
    <label for="throws-input">Počet hodů (výchozí 6):</label>
    <input type="number" id="throws-input" min="1" max="6" value="6" style="width: 50px;" />
  </div>

  <button id="end-training-btn" style="margin-top: 1rem; background:#cc3300; color:#fff;">Ukončit trénink</button>

  <div id="current-training-summary" style="display:none;">
    <strong>Aktuální trénink:</strong><br />
    Série: <span id="series-count">0</span><br />
    Celkem shozeno kubbů: <span id="total-hit">0</span><br />
    Celkem hodů: <span id="total-throws">0</span><br />
    Úspěšnost: <span id="success-rate">0</span>%
  </div>
</section>

<section style="margin-top: 2rem;">
  <h2>Historie</h2>
  <div id="history-list">Vyber uživatele, abys viděl historii.</div>
</section>

<section style="margin-top: 2rem;">
  <button id="undo-last-series-btn">Vrátit poslední sérii</button>
  <div id="training-summary"></div>
</section>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('Service Worker registrován'))
        .catch(err => console.error('Chyba při registraci SW:', err));
    });
  }

  let currentUser = null;
  let currentTraining = [];

  function loadUsers() {
    const usersJSON = localStorage.getItem('kubbUsers');
    return usersJSON ? JSON.parse(usersJSON) : [];
  }

  function saveUsers(users) {
    localStorage.setItem('kubbUsers', JSON.stringify(users));
  }

  function renderUserList() {
    const users = loadUsers();
    const userListDiv = document.getElementById('user-list');
    userListDiv.innerHTML = '';

    users.forEach((user, index) => {
      const userDiv = document.createElement('div');

      const nameSpan = document.createElement('span');
      nameSpan.textContent = user.name;
      nameSpan.style.flexGrow = '1';
      nameSpan.style.userSelect = 'none';
      nameSpan.style.cursor = 'pointer';
      nameSpan.onclick = () => {
        if (currentTraining.length > 0) {
          if (!confirm('Probíhá aktuální trénink, opravdu chceš změnit uživatele? Aktuální trénink bude ztracen.')) {
            return;
          }
          currentTraining = [];
          updateCurrentTrainingSummary();
          document.getElementById('current-training-summary').style.display = 'none';
        }
        currentUser = user.name;
        document.getElementById('current-user-name').textContent = currentUser;
        renderHistory(currentUser);
        resetThrowsInput();
      };

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = 'Smazat';
      deleteBtn.onclick = (e) => {
        e.stopPropagation();
        if (confirm(`Opravdu smazat uživatele "${user.name}"?`)) {
          users.splice(index, 1);
          saveUsers(users);
          renderUserList();
          if (currentUser === user.name) {
            currentUser = null;
            document.getElementById('current-user-name').textContent = 'žádný';
            currentTraining = [];
            updateCurrentTrainingSummary();
            document.getElementById('current-training-summary').style.display = 'none';
            clearHistoryView();
          }
        }
      };

      userDiv.appendChild(nameSpan);
      userDiv.appendChild(deleteBtn);

      userListDiv.appendChild(userDiv);
    });
  }

  document.getElementById('add-user-btn').onclick = () => {
    const input = document.getElementById('user-name-input');
    const name = input.value.trim();
    if (!name) {
      alert('Zadej jméno uživatele.');
      return;
    }
    const users = loadUsers();
    if (users.find(u => u.name === name)) {
      alert('Uživatel s tímto jménem již existuje.');
      return;
    }
    users.push({ name: name, history: [] });
    saveUsers(users);
    input.value = '';
    renderUserList();
  };

  const hitButtons = document.querySelectorAll('.hit-btn');
  hitButtons.forEach(btn => {
    btn.onclick = () => {
      if (!currentUser) {
        alert('Vyber nejdříve uživatele.');
        return;
      }
      const selectedHits = parseInt(btn.getAttribute('data-value'));
      let throwsInput = document.getElementById('throws-input');
      let throws = parseInt(throwsInput.value);
      if (isNaN(throws) || throws < 1) throws = 6;
      if (throws > 6) throws = 6;

      if (selectedHits === 5 && throws !== 5) {
        throws = 5;
        throwsInput.value = 5;
      }

      currentTraining.push({
        hit: selectedHits,
        throws: throws,
        timestamp: new Date().toISOString()
      });

      updateCurrentTrainingSummary();
      resetThrowsInput();
      hitButtons.forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
    };
  });

  function resetThrowsInput() {
    const throwsInput = document.getElementById('throws-input');
    throwsInput.value = 6;
  }

  function updateCurrentTrainingSummary() {
    if (currentTraining.length === 0) {
      document.getElementById('current-training-summary').style.display = 'none';
      return;
    }
    document.getElementById('current-training-summary').style.display = 'block';

    const seriesCount = currentTraining.length;
    const totalHit = currentTraining.reduce((acc, cur) => acc + cur.hit, 0);
    const totalThrows = currentTraining.reduce((acc, cur) => acc + cur.throws, 0);
    const successRate = totalThrows > 0 ? Math.round((totalHit / totalThrows) * 100) : 0;

    document.getElementById('series-count').textContent = seriesCount;
    document.getElementById('total-hit').textContent = totalHit;
    document.getElementById('total-throws').textContent = totalThrows;
    document.getElementById('success-rate').textContent = successRate;
  }

  document.getElementById('end-training-btn').onclick = () => {
    if (!currentUser) {
      alert('Vyber nejdříve uživatele.');
      return;
    }
    if (currentTraining.length === 0) {
      alert('Trénink je prázdný.');
      return;
    }
    const users = loadUsers();
    const userIndex = users.findIndex(u => u.name === currentUser);
    if (userIndex === -1) {
      alert('Uživatel nebyl nalezen.');
      return;
    }
    // Ulož aktuální trénink do historie uživatele
    users[userIndex].history.push({
      date: new Date().toISOString(),
      training: currentTraining
    });
    saveUsers(users);
    currentTraining = [];
    updateCurrentTrainingSummary();
    alert('Trénink uložen.');
    renderHistory(currentUser);
  };

  function renderHistory(userName) {
    const users = loadUsers();
    const user = users.find(u => u.name === userName);
    const historyDiv = document.getElementById('history-list');
    if (!user || !user.history || user.history.length === 0) {
      historyDiv.innerHTML = 'Žádná historie.';
      return;
    }

    historyDiv.innerHTML = '';
    user.history.slice().reverse().forEach(session => {
      const div = document.createElement('div');
      const dateStr = new Date(session.date).toLocaleString();
      let sumHits = session.training.reduce((acc, cur) => acc + cur.hit, 0);
      let sumThrows = session.training.reduce((acc, cur) => acc + cur.throws, 0);
      let success = sumThrows > 0 ? Math.round((sumHits / sumThrows) * 100) : 0;

      div.textContent = `${dateStr} - Série: ${session.training.length}, Shozeno: ${sumHits}, Hodů: ${sumThrows}, Úspěšnost: ${success}%`;
      historyDiv.appendChild(div);
    });
  }

  function clearHistoryView() {
    document.getElementById('history-list').innerHTML = 'Vyber uživatele, abys viděl historii.';
  }

  document.getElementById('undo-last-series-btn').onclick = () => {
    if (currentTraining.length === 0) {
      alert('Žádná série k vrácení.');
      return;
    }
    currentTraining.pop();
    updateCurrentTrainingSummary();
  };

  renderUserList();
</script>

</body>
</html>
